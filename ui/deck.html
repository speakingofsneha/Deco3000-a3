<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slide Deck</title>
  <link rel="stylesheet" href="./deck.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="app">
  <header class="topbar">
    <div class="crumb">
      <span class="crumb__title" id="deck-title">Deck</span>
      <span class="crumb__sep">/</span>
      <span class="crumb__meta" id="deck-meta">10 slides</span>
    </div>
    <div class="actions">
      <button class="btn btn--ghost" id="export">Export</button>
    </div>
  </header>

  <main class="deck" id="deck"></main>
  <script>
    let pdfName = 'slides'; // Default name if not found
    
    function extractPdfName(sourcePdf) {
      if (!sourcePdf) return 'slides';
      const pathParts = sourcePdf.split('/');
      const filename = pathParts[pathParts.length - 1];
      return filename.replace(/\.pdf$/i, '');
    }

    async function loadDeck() {
      const params = new URLSearchParams(window.location.search);
      const file = params.get('file') || '../outputs/latest.json';
      const deckEl = document.getElementById('deck');
      deckEl.innerHTML = '';
      try {
        const res = await fetch(file);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        
        // Extract PDF name from source_pdf
        pdfName = extractPdfName(data.source_pdf);
        
        // Update deck title and page title to show PDF name
        document.getElementById('deck-title').textContent = pdfName;
        document.title = `${pdfName} - Slide Deck`;
        document.getElementById('deck-meta').textContent = `${(data.slides||[]).length} slides`;

        (data.slides || []).forEach((slide, idx) => {
          const section = document.createElement('section');
          const isTitle = slide.type === 'title' && idx === 0;
          section.className = 'slide' + (isTitle ? ' slide--title' : '');

          if (isTitle) {
            const subtitle = (slide.content && slide.content[0] && slide.content[0].text) ? slide.content[0].text : '';
            section.innerHTML = `
              <div class="slide__canvas">
                <div class="title__wrap">
                  <h1 class="title__heading">${slide.title || ''}</h1>
                  ${subtitle ? `<p class=\"title__subtitle\">${subtitle}</p>` : ''}
                </div>
              </div>
            `;
          } else {
            section.innerHTML = `
              <div class="slide__canvas">
                <div class="slide__content">
                  <div class="overline">${idx + 1} / ${(data.slides||[]).length}${slide.provenance && slide.provenance.length ? ' â€¢ ' + slide.provenance.join(', ') : ''}</div>
                  <h1 class="heading">${slide.title || ''}</h1>
                  ${(slide.content||[]).map(b => `<p class=\"body\">${b.text || ''}</p>`).join('')}
                </div>
              </div>
            `;
          }
          deckEl.appendChild(section);
        });
      } catch (e) {
        const section = document.createElement('section');
        section.className = 'slide';
        section.innerHTML = `<div class="slide__canvas"><div class="slide__content"><h1 class="heading">Failed to load</h1><p class="body">${e.message}</p></div></div>`;
        deckEl.appendChild(section);
      }
    }

    async function exportSlides() {
      const slides = document.querySelectorAll('.slide');
      if (slides.length === 0) {
        alert('No slides to export');
        return;
      }

      const button = document.getElementById('export');
      const originalText = button.textContent;
      button.textContent = 'Exporting...';
      button.disabled = true;

      try {
        const zip = new JSZip();
        const canvasPromises = [];

        for (let i = 0; i < slides.length; i++) {
          const slide = slides[i];
          const canvasPromise = html2canvas(slide, {
            backgroundColor: '#ffffff',
            scale: 2,
            useCORS: true,
            logging: false
          }).then(canvas => {
            return new Promise((resolve) => {
              canvas.toBlob((blob) => {
                zip.file(`slide ${i + 1}.png`, blob);
                resolve();
              }, 'image/png');
            });
          });
          canvasPromises.push(canvasPromise);
        }

        await Promise.all(canvasPromises);

        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pdfName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        button.textContent = 'Exported!';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Export failed:', error);
        alert('Export failed: ' + error.message);
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    document.getElementById('export').addEventListener('click', exportSlides);
    document.addEventListener('DOMContentLoaded', loadDeck);
  </script>
</body>
</html>